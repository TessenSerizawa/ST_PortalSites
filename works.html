<!DOCTYPE html>
<html class="no-js" lang="ja">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Site - WORKS</title>
    <meta name="description" content="Explore my portfolio of 3D models, projects, and creative works.">
    
    <!-- フォント -->
    <link href="https://fonts.googleapis.com/css?family=Oswald:400,700|Ubuntu+Condensed|Noto+Sans+JP:400,700" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/gh/sygnas/font-icomoon@1.2.0/style.css" rel="stylesheet">
    
    <!-- CSS -->
    <link rel="stylesheet" href="css/style.css">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://yourusername.github.io/your-repository/works.html">
    <meta property="og:title" content="Portfolio Site - WORKS">
    <meta property="og:description" content="Explore my portfolio of 3D models, projects, and creative works.">
    <meta property="og:image" content="https://yourusername.github.io/your-repository/images/og-image.jpg">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://yourusername.github.io/your-repository/works.html">
    <meta property="twitter:title" content="Portfolio Site - WORKS">
    <meta property="twitter:description" content="Explore my portfolio of 3D models, projects, and creative works.">
    <meta property="twitter:image" content="https://yourusername.github.io/your-repository/images/og-image.jpg">
    
    <style>
        /* WORKS専用のスタイル */
        .works-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 30px;
            margin-top: 30px;
        }
        
        /* タブレット版 */
        @media (max-width: 1024px) {
            .works-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 25px;
            }
        }
        
        .work-item {
            background: #fff;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            min-height: 350px;
        }
        
        .work-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.2);
        }
        
        .work-image {
            width: 100%;
            height: 200px;
            background: linear-gradient(135deg, #f0f0f0 0%, #e0e0e0 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-size: 14px;
            position: relative;
            overflow: hidden;
        }
        
        .work-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    image-rendering: -webkit-optimize-contrast;
    image-rendering: -moz-crisp-edges; 
    image-rendering: crisp-edges;
    image-rendering: auto;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    filter: contrast(1.1) brightness(1.05);
}
        
        .work-content {
            padding: 25px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .work-title {
            font-family: 'Oswald', sans-serif;
            font-size: 20px;
            color: #333;
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .work-description {
            font-size: 14px;
            color: #666;
            line-height: 1.6;
            margin-bottom: 15px;
            flex: 1;
        }
        
        .work-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: auto;
        }
        
        .work-tag {
            padding: 4px 12px;
            background: #f0f0f0;
            color: #666;
            font-size: 12px;
            border-radius: 12px;
            font-weight: 600;
        }
        
        .work-tag--3d {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .work-tag--blender {
            background: #fff3e0;
            color: #f57c00;
        }
        
        .work-tag--unity {
            background: #e8f5e8;
            color: #388e3c;
        }
        
        .work-tag--web {
            background: #fce4ec;
            color: #c2185b;
        }
        
        .work-tag--game {
            background: #f3e5f5;
            color: #7b1fa2;
        }
        
        /* カテゴリフィルター */
        .works-filter {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 10px 20px;
            background: #f5f5f5;
            color: #666;
            border: none;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }
        
        .filter-btn:hover,
        .filter-btn.active {
            background: #333;
            color: #fff;
        }
        
        /* 読み込み状態のスタイル */
        .loading-works {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        .loading-works .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #333;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* エラー状態 */
        .error-works {
            text-align: center;
            padding: 60px 20px;
            color: #e74c3c;
        }
        
        .error-works button {
            padding: 10px 20px;
            background: #333;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s ease;
            margin-top: 15px;
        }
        
        .error-works button:hover {
            background: #555;
        }
        
        @media (max-width: 768px) {
            .works-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .works-filter {
                flex-direction: column;
                align-items: center;
                gap: 10px;
            }
            
            .filter-btn {
                width: 200px;
            }
            
            .work-item {
                max-width: 100%;
            }
            
            .work-content {
                padding: 20px;
            }
            
            .work-title {
                font-size: 18px;
            }
        }
        
        /* 中間サイズのタブレット調整 */
        @media (max-width: 900px) and (min-width: 769px) {
            .works-grid {
                gap: 20px;
            }
            
            .work-content {
                padding: 20px;
            }
        }
    </style>
</head>
<body id="page-works" class="l-body-fit">

<header class="l-header l-header--works">
    <h1 class="l-header__logo">
        <a href="index.html">SITE LOGO</a>
    </h1>

    <nav class="c-mainmenu c-mainmenu--header c-mainmenu--works">
        <ul style="display: contents;">
            <li class="c-mainmenu__item c-mainmenu__item--home">
                <a href="index.html" class="c-mainmenu__link">HOME</a>
            </li>
            <li class="c-mainmenu__item c-mainmenu__item--progress">
                <a href="progress.html" class="c-mainmenu__link">PROGRESS</a>
            </li>
            <li class="c-mainmenu__item c-mainmenu__item--introduction">
                <a href="introduction.html" class="c-mainmenu__link">INTRODUCTION</a>
            </li>
            <li class="c-mainmenu__item c-mainmenu__item--works">
                <a href="works.html" class="c-mainmenu__link active">WORKS</a>
            </li>
            <li class="c-mainmenu__item c-mainmenu__item--link">
                <a href="link.html" class="c-mainmenu__link">LINK</a>
            </li>
        </ul>
    </nav>
</header>

<!--ハンバーガーメニュー-->
<button class="p-hamburger" type="button" aria-label="メニュー">
    <span class="p-hamburger__line"></span>
    <span class="p-hamburger__line"></span>
    <span class="p-hamburger__line"></span>
</button>

<main class="l-wrapper l-wrapper--works">
    <div class="page-content">
        <div class="link-section">
            <h2>WORKS</h2>
            
            <!-- フィルターボタン -->
            <div class="works-filter">
                <button class="filter-btn active" data-filter="all">All</button>
                <button class="filter-btn" data-filter="3d">3D Models</button>
                <button class="filter-btn" data-filter="web">Web Development</button>
                <button class="filter-btn" data-filter="game">Game Development</button>
            </div>
            
            <!-- 読み込み中表示 -->
            <div class="loading-works" id="works-loading-state">
                <div class="spinner"></div>
                <div style="font-size: 18px;">作品を読み込み中...</div>
            </div>
            
            <!-- 作品グリッド -->
            <div class="works-grid" id="works-grid" style="display: none;">
                <!-- 作品がここに動的に追加されます -->
            </div>
            
            <!-- 空状態 -->
            <div class="empty-state" id="works-empty" style="display: none;">
                <h3>該当する作品がありません</h3>
                <p>選択されたカテゴリには作品がありません。</p>
            </div>
            
            <!-- エラー状態 -->
            <div class="error-works" id="works-error-state" style="display: none;">
                <h3>作品の読み込みに失敗しました</h3>
                <p style="margin-bottom: 20px;">GitHubリポジトリから作品データを取得できませんでした。<br>
                設定を確認するか、しばらく時間をおいてから再試行してください。</p>
                <button onclick="loadWorksData()">再試行</button>
            </div>
        </div>
    </div>
</main>

<!-- 作品詳細モーダル -->
<div class="modal-overlay" id="works-modal">
    <div class="modal-content">
        <div class="modal-header">
            <button class="modal-close" id="works-modal-close-btn" type="button" aria-label="閉じる">×</button>
            <h1 class="modal-title" id="works-modal-title">作品タイトル</h1>
            <div class="modal-meta">
                <span class="modal-date" id="works-modal-date">2025.07.06</span>
                <div id="works-modal-tags"></div>
            </div>
        </div>
        <div class="modal-body">
            <div class="modal-content-text" id="works-modal-content">
                <p>作品の詳細がここに表示されます。</p>
            </div>
        </div>
    </div>
</div>

<footer class="l-footer">
    <p>©2025 Portfolio Site. All rights reserved.</p>
</footer>

<script src="js/script.js"></script>
<script>
// WORKS専用の設定
const WORKS_CONFIG = {
    owner: 'TessenSerizawa',
    repo: 'ST_PortalSites',
    branch: 'master',
    postsPath: '_works_posts',
    useGitHubPages: true
};

// 作品データを格納する変数
let allWorks = [];
let currentWorksCategory = 'all';
let isWorksLoading = false;

// ページ固有の初期化
document.addEventListener('DOMContentLoaded', function() {
    initPage('works');
    initWorksPage();
});

// WORKS専用の初期化
function initWorksPage() {
    loadWorksData();
    initWorksFilter();
    initWorksModal();
}

// 作品データを読み込み
async function loadWorksData() {
    if (isWorksLoading) return;
    
    isWorksLoading = true;
    showWorksLoadingState();

    try {
        console.log('作品データを読み込み中...');
        
        let works = [];
        
        // GitHub APIで作品ファイルを取得
        try {
            works = await loadWorksFromGitHubAPI();
            console.log('GitHub APIから作品を取得しました:', works.length, '件');
        } catch (apiError) {
            console.warn('GitHub API取得に失敗:', apiError);
            
            // 既知のファイルをダイレクトに取得
            try {
                works = await loadKnownWorksFiles();
                console.log('既知のファイルから作品を取得しました:', works.length, '件');
            } catch (directError) {
                console.warn('ダイレクト取得に失敗:', directError);
                
                // サンプルデータを使用
                works = getSampleWorks();
                console.log('サンプルデータを使用します:', works.length, '件');
            }
        }

        if (works.length === 0) {
            throw new Error('作品が見つかりませんでした');
        }

        // 作品をソート（新しい順）
        allWorks = works.sort((a, b) => b.pubDate - a.pubDate);
        
        // 作品を表示
        displayWorks(allWorks);
        
    } catch (error) {
        console.error('作品の読み込みに失敗:', error);
        showWorksError(error);
    } finally {
        isWorksLoading = false;
    }
}

// GitHub APIから作品を取得
async function loadWorksFromGitHubAPI() {
    const apiUrl = `https://api.github.com/repos/${WORKS_CONFIG.owner}/${WORKS_CONFIG.repo}/contents/${WORKS_CONFIG.postsPath}?ref=${WORKS_CONFIG.branch}`;
    
    console.log('Works GitHub API URL:', apiUrl);
    
    const response = await fetch(apiUrl);
    
    if (!response.ok) {
        if (response.status === 404) {
            throw new Error(`${WORKS_CONFIG.postsPath} フォルダが見つかりません (404)`);
        } else if (response.status === 403) {
            throw new Error(`GitHub API の制限に達しました (403)`);
        } else {
            throw new Error(`GitHub API エラー: ${response.status} ${response.statusText}`);
        }
    }

    const files = await response.json();
    
    if (!Array.isArray(files)) {
        throw new Error('ファイルリストの取得に失敗しました');
    }

    const markdownFiles = files.filter(file => 
        file.type === 'file' && file.name.endsWith('.md')
    );

    if (markdownFiles.length === 0) {
        throw new Error('Markdownファイルが見つかりません');
    }

    const works = await Promise.all(
        markdownFiles.map(async (file) => {
            try {
                const content = await fetchFileContent(file.download_url);
                return parseWorksMarkdownFile(file.name, content);
            } catch (error) {
                console.error(`Error loading works ${file.name}:`, error);
                return null;
            }
        })
    );

    return works.filter(work => work !== null);
}

// 既知のファイルを直接取得
async function loadKnownWorksFiles() {
    const knownFiles = [
        // ここに既知のファイル名を追加
        // '2025-07-08-sample-work.md',
    ];

    if (knownFiles.length === 0) {
        throw new Error('既知のファイルが設定されていません');
    }

    const works = await Promise.all(
        knownFiles.map(async (filename) => {
            try {
                const rawUrl = `https://raw.githubusercontent.com/${WORKS_CONFIG.owner}/${WORKS_CONFIG.repo}/${WORKS_CONFIG.branch}/${WORKS_CONFIG.postsPath}/${filename}`;
                const content = await fetchFileContent(rawUrl);
                return parseWorksMarkdownFile(filename, content);
            } catch (error) {
                console.error(`Error loading works ${filename}:`, error);
                return null;
            }
        })
    );

    return works.filter(work => work !== null);
}

// サンプル作品データ
function getSampleWorks() {
    return [
        {
            title: 'キャラクターモデル Vol.1',
            description: 'Blenderで制作したオリジナルキャラクターの3Dモデルです。リギング、テクスチャリングまで完了しており、VRChatやUnityで使用可能です。',
            fullContent: `
                <h1>キャラクターモデル Vol.1</h1>
                <img src="assets/images/works/sample-character.jpg" alt="キャラクターモデル" style="max-width: 100%; height: auto; margin: 10px 0; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <p>Blenderで制作したオリジナルキャラクターの3Dモデルです。</p>
                <h2>特徴</h2>
                <ul>
                    <li>完全リギング済み</li>
                    <li>高品質テクスチャ</li>
                    <li>VRChat対応</li>
                    <li>Unity対応</li>
                </ul>
                <h2>技術仕様</h2>
                <p>ポリゴン数: 約15,000<br>
                テクスチャ解像度: 2048x2048<br>
                ボーン数: 85</p>
                <p><em>※ これはサンプルデータです。実際の作品を表示するには、${WORKS_CONFIG.postsPath}フォルダにMarkdownファイルを追加してください。</em></p>
            `,
            pubDate: new Date(2025, 6, 8),
            category: '3d',
            tags: ['3D', 'Blender', 'Character'],
            image: '',
            filename: 'sample-character.md'
        },
        {
            title: 'ポートフォリオサイト',
            description: 'レスポンシブデザインに対応したポートフォリオサイト。モダンなUIとスムーズなアニメーションが特徴です。',
            fullContent: `
                <h1>ポートフォリオサイト</h1>
                <p>レスポンシブデザインに対応したポートフォリオサイトです。</p>
                <h2>技術スタック</h2>
                <ul>
                    <li>HTML5</li>
                    <li>CSS3</li>
                    <li>JavaScript ES6+</li>
                    <li>GitHub Pages</li>
                </ul>
                <h2>主な機能</h2>
                <ul>
                    <li>レスポンシブデザイン</li>
                    <li>スムーズアニメーション</li>
                    <li>モーダル表示</li>
                    <li>カテゴリフィルタリング</li>
                </ul>
                <p><em>※ これはサンプルデータです。</em></p>
            `,
            pubDate: new Date(2025, 6, 5),
            category: 'web',
            tags: ['Web', 'HTML/CSS', 'JavaScript'],
            image: '',
            filename: 'sample-portfolio.md'
        },
        {
            title: '2Dパズルゲーム',
            description: 'Unityで制作したシンプルなパズルゲーム。直感的な操作とやりごたえのある難易度設定が特徴です。',
            fullContent: `
                <h1>2Dパズルゲーム</h1>
                <p>Unityで制作したシンプルなパズルゲームです。</p>
                <h2>ゲーム仕様</h2>
                <ul>
                    <li>ステージ数: 50</li>
                    <li>プラットフォーム: PC/モバイル</li>
                    <li>操作方法: タップ/クリック</li>
                </ul>
                <h2>使用技術</h2>
                <ul>
                    <li>Unity 2022.3 LTS</li>
                    <li>C#</li>
                    <li>Unity UI</li>
                </ul>
                <p><em>※ これはサンプルデータです。</em></p>
            `,
            pubDate: new Date(2025, 6, 1),
            category: 'game',
            tags: ['Game', 'Unity', 'C#'],
            image: '',
            filename: 'sample-puzzle-game.md'
        }
    ];
}

// 作品Markdownファイルを解析
function parseWorksMarkdownFile(filename, content) {
    try {
        console.log(`Parsing works file: ${filename}`);
        
        // ファイル名から日付を抽出
        const filenameParts = filename.replace('.md', '').split('-');
        
        let year, month, day, titleFromFilename;
        
        if (filenameParts.length >= 4) {
            year = parseInt(filenameParts[0]);
            month = parseInt(filenameParts[1]);
            day = parseInt(filenameParts[2]);
            titleFromFilename = filenameParts.slice(3).join('-');
        } else {
            const now = new Date();
            year = now.getFullYear();
            month = now.getMonth() + 1;
            day = now.getDate();
            titleFromFilename = filename.replace('.md', '');
        }

        // デフォルト値
        let title = titleFromFilename;
        let category = '3d';
        let description = '';
        let tags = [];
        let image = '';
        let pubDate = new Date(year, month - 1, day);

        // フロントマターの解析
        const lines = content.split('\n');
        let frontMatterEnd = -1;
        let bodyStartIndex = 0;

        if (lines[0] === '---') {
            for (let i = 1; i < lines.length; i++) {
                if (lines[i] === '---') {
                    frontMatterEnd = i;
                    break;
                }
            }

            if (frontMatterEnd > 0) {
                const frontMatter = lines.slice(1, frontMatterEnd);
                
                frontMatter.forEach(line => {
                    const colonIndex = line.indexOf(':');
                    if (colonIndex === -1) return;
                    
                    const key = line.substring(0, colonIndex).trim();
                    const value = line.substring(colonIndex + 1).trim();
                    
                    if (!key || !value) return;
                    
                    const cleanValue = value.replace(/^["']|["']$/g, '');
                    
                    switch (key) {
                        case 'title':
                            title = cleanValue;
                            break;
                        case 'category':
                        case 'categories':
                            category = cleanValue;
                            break;
                        case 'description':
                        case 'excerpt':
                            description = cleanValue;
                            break;
                        case 'tags':
                            tags = cleanValue.split(',').map(tag => tag.trim());
                            break;
                        case 'image':
                            image = cleanValue;
                            break;
                        case 'date':
                            try {
                                pubDate = new Date(cleanValue);
                                if (isNaN(pubDate.getTime())) {
                                    pubDate = new Date(year, month - 1, day);
                                }
                            } catch (e) {
                                pubDate = new Date(year, month - 1, day);
                            }
                            break;
                    }
                });
                
                bodyStartIndex = frontMatterEnd + 1;
            }
        }

        // 本文を取得
        const bodyLines = lines.slice(bodyStartIndex);
        const fullContent = bodyLines.join('\n');

        // タイトルが設定されていない場合は、最初の見出しを使用
        if (!title || title === titleFromFilename) {
            const firstHeading = bodyLines.find(line => line.startsWith('#'));
            if (firstHeading) {
                title = firstHeading.replace(/^#+\s*/, '').trim();
            }
        }

        // 説明文が設定されていない場合は、本文から生成
        if (!description) {
            const textContent = fullContent
                .replace(/^#+\s+.*/gm, '')
                .replace(/!\[.*?\]\(.*?\)/g, '')
                .replace(/\[.*?\]\(.*?\)/g, '')
                .replace(/[*_`]/g, '')
                .replace(/\n\s*\n/g, '\n')
                .trim();
            
            description = textContent.substring(0, 150) + (textContent.length > 150 ? '...' : '');
        }

        // 画像がフロントマターで設定されていない場合、本文から最初の画像を抽出
        if (!image) {
            const imageMatch = fullContent.match(/!\[.*?\]\(([^)]+)\)/);
            if (imageMatch) {
                image = imageMatch[1];
            }
        }

        // 画像パスを絶対URLに変換
        if (image) {
            image = convertImagePath(image);
        }

        const work = {
            title: title,
            description: description,
            fullContent: convertMarkdownToHtml(fullContent),
            pubDate: pubDate,
            category: category,
            tags: tags,
            image: image,
            filename: filename
        };

        console.log(`Successfully parsed works: ${filename}`, work);
        return work;

    } catch (error) {
        console.error(`Error parsing works ${filename}:`, error);
        return null;
    }
}

// 作品を表示
function displayWorks(works) {
    const worksGrid = document.getElementById('works-grid');
    const loadingState = document.getElementById('works-loading-state');
    const emptyState = document.getElementById('works-empty');

    if (!worksGrid) return;

    hideWorksLoadingState();

    if (works.length === 0) {
        showWorksEmptyState();
        return;
    }

    hideWorksEmptyState();
    worksGrid.innerHTML = '';
    worksGrid.style.display = 'grid';

    works.forEach((work, index) => {
        const workItem = document.createElement('div');
        workItem.className = 'work-item';
        workItem.setAttribute('data-category', work.category);
        workItem.setAttribute('data-work-index', index);

        const categoryTags = work.tags.map(tag => {
            const tagClass = getTagClass(tag);
            return `<span class="work-tag ${tagClass}">${tag}</span>`;
        }).join('');

        workItem.innerHTML = `
            <div class="work-image">
                ${work.image ? 
                    `<img src="${work.image}" alt="${escapeHtml(work.title)}" loading="lazy" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                     <span style="display: none;">作品画像</span>` : 
                    `<span>作品画像</span>`
                }
            </div>
            <div class="work-content">
                <h3 class="work-title">${escapeHtml(work.title)}</h3>
                <p class="work-description">${escapeHtml(work.description)}</p>
                <div class="work-tags">
                    ${categoryTags}
                </div>
            </div>
        `;

        workItem.addEventListener('click', () => {
            showWorksModal(work);
        });

        worksGrid.appendChild(workItem);
    });
}

// タグのクラスを取得
function getTagClass(tag) {
    const tagLower = tag.toLowerCase();
    if (tagLower.includes('3d')) return 'work-tag--3d';
    if (tagLower.includes('blender')) return 'work-tag--blender';
    if (tagLower.includes('unity')) return 'work-tag--unity';
    if (tagLower.includes('web') || tagLower.includes('html') || tagLower.includes('css') || tagLower.includes('javascript')) return 'work-tag--web';
    if (tagLower.includes('game')) return 'work-tag--game';
    return '';
}

// フィルタリング機能の初期化
function initWorksFilter() {
    const filterBtns = document.querySelectorAll('.filter-btn');
    
    filterBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            filterBtns.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            const filter = this.getAttribute('data-filter');
            filterWorks(filter);
        });
    });
}

// Markdown to HTML変換（WORKS専用）
function convertMarkdownToHtml(markdown) {
    let html = markdown;
    
    // 画像（最初に処理して他の変換と競合しないようにする）
    html = html.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, alt, src) {
        const imageSrc = convertImagePath(src);
        return `<img src="${imageSrc}" alt="${alt}" loading="lazy" style="max-width: 100%; height: auto; margin: 10px 0; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">`;
    });
    
    // 見出し
    html = html.replace(/^### (.*$)/gm, '<h3>$1</h3>');
    html = html.replace(/^## (.*$)/gm, '<h2>$1</h2>');
    html = html.replace(/^# (.*$)/gm, '<h1>$1</h1>');
    
    // 太字
    html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    html = html.replace(/__(.*?)__/g, '<strong>$1</strong>');
    
    // 斜体
    html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
    html = html.replace(/_(.*?)_/g, '<em>$1</em>');
    
    // リンク
    html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>');
    
    // コードブロック
    html = html.replace(/```(\w+)?\n([\s\S]*?)```/g, function(match, lang, code) {
        const language = lang ? ` class="language-${lang}"` : '';
        return `<pre style="background: #f4f4f4; padding: 15px; border-radius: 5px; overflow-x: auto; margin: 15px 0;"><code${language}>${escapeHtml(code.trim())}</code></pre>`;
    });
    
    // インラインコード
    html = html.replace(/`([^`]+)`/g, '<code style="background: #f4f4f4; padding: 2px 4px; border-radius: 3px; font-family: monospace;">$1</code>');
    
    // 水平線
    html = html.replace(/^---$/gm, '<hr style="margin: 20px 0; border: none; border-top: 1px solid #ddd;">');
    
    // リスト（順序なし）
    html = html.replace(/^- (.*$)/gm, '<li>$1</li>');
    html = html.replace(/(<li>.*<\/li>)/gs, function(match) {
        return '<ul>' + match + '</ul>';
    });
    
    // リスト（順序あり）
    html = html.replace(/^\d+\. (.*$)/gm, '<li>$1</li>');
    html = html.replace(/(<li>.*<\/li>)/gs, function(match) {
        // 既に<ul>で囲まれている場合はスキップ
        if (match.includes('<ul>')) return match;
        return '<ol>' + match + '</ol>';
    });
    
    // 改行をpタグに変換
    const paragraphs = html.split('\n\n');
    html = paragraphs.map(p => {
        p = p.trim();
        if (p && !p.startsWith('<') && !p.includes('<img') && !p.startsWith('---')) {
            return '<p>' + p.replace(/\n/g, '<br>') + '</p>';
        }
        return p;
    }).join('\n');
    
    return html;
}

// 作品をフィルタリング
function filterWorks(category) {
    currentWorksCategory = category;
    let filteredWorks = allWorks;
    
    if (category !== 'all') {
        filteredWorks = allWorks.filter(work => work.category === category);
    }
    
    displayWorks(filteredWorks);
}

// モーダル機能の初期化
function initWorksModal() {
    const modal = document.getElementById('works-modal');
    const modalCloseBtn = document.getElementById('works-modal-close-btn');

    if (!modal || !modalCloseBtn) return;

    modalCloseBtn.addEventListener('click', closeWorksModal);
    
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            closeWorksModal();
        }
    });

    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modal.classList.contains('show')) {
            closeWorksModal();
        }
    });
}

// 作品モーダルを表示
function showWorksModal(work) {
    const modal = document.getElementById('works-modal');
    const modalTitle = document.getElementById('works-modal-title');
    const modalDate = document.getElementById('works-modal-date');
    const modalTags = document.getElementById('works-modal-tags');
    const modalContent = document.getElementById('works-modal-content');

    if (!modal || !modalTitle || !modalDate || !modalTags || !modalContent) return;

    modalTitle.textContent = work.title;
    modalDate.textContent = formatDate(work.pubDate);
    
    // タグを設定
    const tagsHtml = work.tags.map(tag => {
        const tagClass = getTagClass(tag);
        return `<span class="work-tag ${tagClass}" style="margin-right: 8px;">${tag}</span>`;
    }).join('');
    modalTags.innerHTML = tagsHtml;
    
    // コンテンツを設定
    modalContent.innerHTML = work.fullContent;
    
    // モーダルを表示
    modal.classList.add('show');
    document.body.style.overflow = 'hidden';
}

// 作品モーダルを閉じる
function closeWorksModal() {
    const modal = document.getElementById('works-modal');
    if (modal) {
        modal.classList.remove('show');
        document.body.style.overflow = '';
    }
}

// 状態管理関数
function showWorksLoadingState() {
    const loadingState = document.getElementById('works-loading-state');
    const errorState = document.getElementById('works-error-state');
    const emptyState = document.getElementById('works-empty');
    const worksGrid = document.getElementById('works-grid');
    
    if (loadingState) loadingState.style.display = 'block';
    if (errorState) errorState.style.display = 'none';
    if (emptyState) emptyState.style.display = 'none';
    if (worksGrid) worksGrid.style.display = 'none';
}

function hideWorksLoadingState() {
    const loadingState = document.getElementById('works-loading-state');
    if (loadingState) loadingState.style.display = 'none';
}

function showWorksEmptyState() {
    const loadingState = document.getElementById('works-loading-state');
    const errorState = document.getElementById('works-error-state');
    const emptyState = document.getElementById('works-empty');
    const worksGrid = document.getElementById('works-grid');
    
    if (loadingState) loadingState.style.display = 'none';
    if (errorState) errorState.style.display = 'none';
    if (emptyState) emptyState.style.display = 'block';
    if (worksGrid) worksGrid.style.display = 'none';
}

function hideWorksEmptyState() {
    const emptyState = document.getElementById('works-empty');
    if (emptyState) emptyState.style.display = 'none';
}

function showWorksError(error) {
    const errorState = document.getElementById('works-error-state');
    const loadingState = document.getElementById('works-loading-state');
    const emptyState = document.getElementById('works-empty');
    const worksGrid = document.getElementById('works-grid');
    
    if (loadingState) loadingState.style.display = 'none';
    if (emptyState) emptyState.style.display = 'none';
    if (worksGrid) worksGrid.style.display = 'none';
    
    if (errorState) {
        errorState.innerHTML = `
            <h3>作品の読み込みに失敗しました</h3>
            <p style="margin-bottom: 15px;"><strong>エラー:</strong> ${error.message}</p>
            <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 15px 0; text-align: left;">
                <p><strong>考えられる原因:</strong></p>
                <ul style="margin: 10px 0; padding-left: 20px;">
                    <li>${WORKS_CONFIG.postsPath} フォルダが存在しない</li>
                    <li>Markdownファイルが存在しない</li>
                    <li>GitHub設定が正しくない</li>
                    <li>GitHub APIのレート制限</li>
                    <li>ネットワーク接続の問題</li>
                </ul>
                <p><strong>現在の設定:</strong></p>
                <ul style="margin: 10px 0; padding-left: 20px;">
                    <li>Owner: ${WORKS_CONFIG.owner}</li>
                    <li>Repository: ${WORKS_CONFIG.repo}</li>
                    <li>Branch: ${WORKS_CONFIG.branch}</li>
                    <li>Posts Path: ${WORKS_CONFIG.postsPath}</li>
                </ul>
            </div>
            <button onclick="loadWorksData()" style="margin-right: 10px;">再試行</button>
            <button onclick="location.reload()">ページをリロード</button>
        `;
        errorState.style.display = 'block';
    }
}

// グローバル関数として定義
window.loadWorksData = loadWorksData;
</script>

</body>
</html>
